<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2196f3">
    <title>Mess Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --accent-orange: #f97316;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-blue: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--dark);
            min-height: 100vh;
            padding: 10px;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.9);
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }
        
        .status-dot.connected {
            background: var(--accent-green);
            animation: none;
        }
        
        .login-btn {
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: var(--shadow);
            font-size: 11px;
            flex-shrink: 0;
        }
        
        .login-btn i, .user-info i {
            font-size: 12px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.9);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }
        
        .logout-btn {
            background: var(--accent-red);
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 8px;
            box-shadow: var(--shadow);
        }

        .tab-btn {
            padding: 8px 6px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--dark);
            font-size: 12px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 40px;
            word-break: break-word;
            line-height: 1.2;
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-title {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
            color: var(--primary);
            font-size: 1.2rem;
            text-align: center;
        }
        
        .form-container {
            background: var(--light);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 13px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-orange {
            background: var(--accent-orange);
            color: white;
        }
        
        .btn-green {
            background: var(--accent-green);
            color: white;
        }
        
        .btn-red {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-yellow {
            background: var(--accent-yellow);
            color: white;
        }
        
        .btn-sm {
            padding: 5px 8px;
            font-size: 12px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .edit-btn {
            color: var(--accent-yellow);
        }
        
        .delete-btn {
            color: var(--accent-red);
        }
        
        .icon-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        
        .menu-tile {
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .today-menu-tile {
            background: linear-gradient(135deg, var(--accent-green), #34d399);
        }
        
        .tomorrow-menu-tile {
            background: linear-gradient(135deg, var(--accent-blue), #60a5fa);
        }
        
        .menu-header {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .menu-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }
        
        .menu-category {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 6px;
        }
        
        .menu-category h4 {
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .history-data {
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        th, td {
            padding: 8px 10px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        .user-tiles {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }
        
        .user-tile {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--accent-orange);
        }
        
        .user-tile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        /* Vertical demand table styling */
        .vertical-demand-table {
            width: 100%;
            margin-top: 8px;
            font-size: 12px;
            border-collapse: collapse;
            border: 1px solid #e2e8f0;
        }

        .vertical-demand-table th {
            background: var(--secondary);
            padding: 6px 3px;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 11px;
        }

        .vertical-demand-table td {
            padding: 4px 3px;
            vertical-align: middle;
            border: 1px solid #e2e8f0;
        }

        .vertical-demand-table .type-cell {
            background: #f8fafc;
            font-weight: 600;
            text-align: center;
            border-right: 2px solid #cbd5e1;
            vertical-align: middle;
            max-width: 18%;
            padding: 4px 2px;
            font-size: 11px;
        }

        .vertical-demand-table .menu-cell {
            padding: 4px 6px;
            width: 65%;
            border-right: 1px solid #e2e8f0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 11px;
        }

        .vertical-demand-table .action-cell {
            text-align: center;
            width: 17%;
            padding: 2px 5% !important;
            margin-left: 20px;
        }

        .vertical-demand-table .action-cell .action-cell {
            display: flex;
            gap: 3px;
            justify-content: center;
            align-items: center;
            padding: 0 !important;
        }

        .vertical-demand-table .action-cell .icon-btn {
            padding: 3px;
            font-size: 11px;
            min-width: 22px;
            min-height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .highlight-row {
            background-color: #fff9e6 !important;
            border-left: 3px solid var(--accent-yellow) !important;
            font-weight: 600;
        }
        
        .multi-select {
            height: 80px;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        /* Weekly Menu Styles */
        .weekly-menu-container {
            margin-top: 15px;
        }
        
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .week-nav-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .week-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .weekly-menu-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .weekly-menu-table th {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .weekly-menu-table td {
            padding: 10px;
            border: 1px solid #e2e8f0;
            vertical-align: top;
        }
        
        .day-header {
            background: var(--secondary);
            color: white;
            font-weight: 600;
            text-align: center;
        }
        
        .today-cell {
            background-color: #f0f9ff;
            border-left: 3px solid var(--accent-blue);
        }
        
        .meal-category {
            margin-bottom: 8px;
        }
        
        .meal-category:last-child {
            margin-bottom: 0;
        }
        
        .meal-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--dark);
        }
        
        .login-modal-content {
            max-width: 350px;
        }
        
        .login-form {
            margin-top: 15px;
        }
        
        .login-error {
            color: var(--accent-red);
            font-size: 12px;
            margin-top: 8px;
            text-align: center;
            display: none;
        }
        
        .notes-list {
            margin-top: 12px;
        }
        
        .note-item {
            background: #fff9e6;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-yellow);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .note-content {
            flex: 1;
        }
        
        .note-date {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        /* View Toggle Styles */
        .view-toggle {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            background: var(--light);
            border-radius: 8px;
            padding: 8px;
            box-shadow: var(--shadow);
        }
        
        .toggle-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .toggle-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* Type-wise demand tiles */
        .type-tile {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }
        
        .type-tile-breakfast {
            border-left: 4px solid #f59e0b;
        }
        
        .type-tile-lunch {
            border-left: 4px solid #10b981;
        }
        
        .type-tile-dinner {
            border-left: 4px solid #3b82f6;
        }
        
        .type-tile-other {
            border-left: 4px solid #8b5cf6;
        }
        
        .type-tile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        /* Date selector and view toggle in single row */
        .demand-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            background: var(--light);
            padding: 10px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }
        
        .date-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }
        
        .date-selector label {
            margin-bottom: 0;
            font-weight: 600;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .date-selector input {
            flex: 1;
            min-width: 120px;
        }
        
        .view-toggle-container {
            display: flex;
            gap: 5px;
            background: #e2e8f0;
            padding: 4px;
            border-radius: 6px;
        }
        
        .view-toggle-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .demand-title {
            text-align: center;
            margin: 10px 0;
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .menu-content {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .nav-tabs {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
                padding: 6px;
            }
            
            .tab-btn {
                font-size: 11px;
                padding: 6px 4px;
                min-height: 36px;
            }
            
            .top-bar {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .connection-status, .login-btn, .user-info {
                font-size: 10px;
                padding: 5px 8px;
            }
            
            .status-dot {
                width: 8px;
                height: 8px;
            }
            
            .login-btn i, .user-info i {
                font-size: 10px;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .vertical-demand-table {
                font-size: 10px;
            }
            
            .vertical-demand-table th {
                padding: 4px 2px;
                font-size: 10px;
            }
            
            .vertical-demand-table td {
                padding: 3px 2px;
            }
            
            .vertical-demand-table .type-cell {
                width: 20%;
                padding: 3px 1px;
                font-size: 10px;
            }
            
            .vertical-demand-table .menu-cell {
                width: 55%;
                padding: 3px 4px;
                font-size: 10px;
            }
            
            .vertical-demand-table .action-cell {
                width: 25%;
                padding: 1px !important;
            }
            
            .vertical-demand-table .action-cell .action-cell {
                gap: 2px;
            }
            
            .vertical-demand-table .action-cell .icon-btn {
                padding: 2px;
                font-size: 10px;
                min-width: 20px;
                min-height: 20px;
            }
            
            .demand-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-selector {
                min-width: 100%;
            }
            
            .view-toggle-container {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 360px) {
            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .connection-status, .login-btn, .user-info {
                justify-content: center;
                text-align: center;
            }
            
            .vertical-demand-table th {
                font-size: 9px;
                padding: 3px 1px;
            }
            
            .vertical-demand-table .type-cell {
                font-size: 9px;
            }
            
            .vertical-demand-table .menu-cell {
                font-size: 9px;
            }
            
            .vertical-demand-table .action-cell .icon-btn {
                padding-left: 1px;
                font-size: 9px;
                min-width: 18px;
                min-height: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content login-modal-content">
            <div class="modal-header">
                <h3>Admin Login</h3>
                <button class="close-btn" id="close-login-modal">&times;</button>
            </div>
            <form id="login-form" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <div class="login-error" id="login-error">
                    Invalid username or password
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="top-bar">
            <div class="connection-status">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Connecting...</span>
            </div>
            
            <button class="login-btn" id="open-login-btn">
                <i class="fas fa-user"></i> <span class="login-text">Admin</span>
            </button>
            
            <div class="user-info" id="user-info" style="display: none;">
                <i class="fas fa-user-shield"></i>
                <span>Admin</span>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" data-tab="mess-menu">Menu</button>
            <button class="tab-btn" data-tab="weekly-menu">Weekly Menu</button>
            <button class="tab-btn" data-tab="demand">Demand</button>
            <button class="tab-btn" data-tab="users" id="users-tab" style="display: none;">Users</button>
            <button class="tab-btn" data-tab="notes">Notes</button>
            <button class="tab-btn" data-tab="data" id="data-tab" style="display: none;">Data</button>
        </div>
        
        <!-- Mess Menu Section -->
        <div id="mess-menu" class="tab-content active">
            <h2 class="section-title">Mess Menu</h2>
            
            <!-- Today's Menu Tile -->
            <div id="today-menu-tile" class="menu-tile today-menu-tile">
                <div class="menu-header">
                    <h3>Today's Menu</h3>
                </div>
                <div class="menu-content">
                    <div class="menu-category">
                        <h4>Breakfast</h4>
                        <div id="today-breakfast">-</div>
                    </div>
                    <div class="menu-category">
                        <h4>Lunch</h4>
                        <div id="today-lunch">-</div>
                    </div>
                    <div class="menu-category">
                        <h4>Dinner</h4>
                        <div id="today-dinner">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Tomorrow's Menu Tile -->
            <div id="tomorrow-menu-tile" class="menu-tile tomorrow-menu-tile">
                <div class="menu-header">
                    <h3>Tomorrow's Menu</h3>
                </div>
                <div class="menu-content">
                    <div class="menu-category">
                        <h4>Breakfast</h4>
                        <div id="tomorrow-breakfast">-</div>
                    </div>
                    <div class="menu-category">
                        <h4>Lunch</h4>
                        <div id="tomorrow-lunch">-</div>
                    </div>
                    <div class="menu-category">
                        <h4>Dinner</h4>
                        <div id="tomorrow-dinner">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Admin-only form -->
            <div class="form-container" id="menu-form-container" style="display: none;">
                <h3>Add/Update Menu</h3>
                <form id="menu-form">
                    <div class="form-group">
                        <label for="menu-date">Date</label>
                        <input type="date" id="menu-date" required>
                    </div>
                    <div class="form-group">
                        <label for="breakfast">Breakfast</label>
                        <input type="text" id="breakfast" required>
                    </div>
                    <div class="form-group">
                        <label for="lunch">Lunch</label>
                        <input type="text" id="lunch" required>
                    </div>
                    <div class="form-group">
                        <label for="dinner">Dinner</label>
                        <input type="text" id="dinner" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add/Update Menu
                    </button>
                </form>
            </div>
            
            <!-- Admin-only history -->
            <div class="history-data" id="menu-history-container" style="display: none;">
                <h3>All Menus</h3>
                <table id="menu-history">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Breakfast</th>
                            <th>Lunch</th>
                            <th>Dinner</th>
                            <th id="menu-history-action-header">Action</th>
                        </tr>
                    </thead>
                    <tbody id="menu-history-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Weekly Menu Section -->
        <div id="weekly-menu" class="tab-content">
            <h2 class="section-title">Weekly Menu</h2>
            
            <div class="week-nav">
                <button class="week-nav-btn" id="prev-week">
                    <i class="fas fa-chevron-left"></i> Previous Week
                </button>
                <div class="week-title" id="week-title">This Week</div>
                <button class="week-nav-btn" id="next-week">
                    Next Week <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="form-container" id="weekly-menu-admin" style="display: none;">
                <h3>Add/Update Weekly Menu</h3>
                <form id="weekly-menu-form">
                    <div class="form-group">
                        <label for="week-start-date">Week Starting Date</label>
                        <input type="date" id="week-start-date" required>
                    </div>
                    <div id="weekly-menu-days">
                        <!-- Weekly menu form will be generated here -->
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Save Weekly Menu
                    </button>
                </form>
            </div>
            
            <div class="weekly-menu-container">
                <table class="weekly-menu-table" id="weekly-menu-table">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Breakfast</th>
                            <th>Lunch</th>
                            <th>Dinner</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-menu-body">
                        <!-- Weekly menu will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Demand Section -->
        <div id="demand" class="tab-content">
            <h2 class="section-title">Demand</h2>
            
            <!-- Controls Row -->
            <div class="demand-controls">
                <!-- Date Selector -->
                <div class="date-selector">
                    <label for="demand-view-date">Date:</label>
                    <input type="date" id="demand-view-date">
                </div>
                
                <!-- View Toggle -->
                <div class="view-toggle-container">
                    <button class="view-toggle-btn active" id="user-view-btn">User View</button>
                    <button class="view-toggle-btn" id="type-view-btn">Type View</button>
                </div>
            </div>
            
            <!-- Demand Title -->
            <div class="demand-title" id="demand-date-title">Today's Demand</div>
            
            <!-- Today's Demand Tile -->
            <div id="today-demand-tile">
                <!-- User-wise view -->
                <div id="user-wise-view">
                    <div id="today-demand-content" class="user-tiles">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Type-wise view -->
                <div id="type-wise-view" style="display: none;">
                    <div id="today-demand-type-content" class="user-tiles">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Admin-only form -->
            <div class="form-container" id="demand-form-container" style="display: none;">
                <h3>Add Demand</h3>
                <form id="demand-form">
                    <div class="form-group">
                        <label for="demand-type">Type</label>
                        <select id="demand-type" required>
                            <option value="">Select Type</option>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="demand-date">Date</label>
                        <input type="date" id="demand-date" required>
                    </div>
                    <div class="form-group">
                        <label for="demand-users">Users (Multiple)</label>
                        <select id="demand-users" multiple class="multi-select" required>
                            <option value="">Select Users</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="demand-menu">Menu</label>
                        <input type="text" id="demand-menu" required>
                    </div>
                    <div class="form-group">
                        <label for="demand-remarks">Remarks</label>
                        <textarea id="demand-remarks" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Demand
                    </button>
                </form>
            </div>
            
            <!-- Admin-only history -->
            <div class="history-data" id="demand-history-container" style="display: none;">
                <h3>Demand History</h3>
                
                <!-- Filter Controls -->
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="user-filter">Filter by User</label>
                        <select id="user-filter">
                            <option value="">All Users</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="date-filter">Filter by Date</label>
                        <input type="date" id="date-filter">
                    </div>
                    <div class="filter-group">
                        <label for="type-filter">Filter by Type</label>
                        <select id="type-filter">
                            <option value="">All Types</option>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <table id="demand-history">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Type</th>
                            <th>Menu</th>
                            <th>Remarks</th>
                            <th id="demand-history-action-header">Action</th>
                        </tr>
                    </thead>
                    <tbody id="demand-history-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Users Section -->
        <div id="users" class="tab-content">
            <h2 class="section-title">Users</h2>
            
            <div class="form-container">
                <h3>Add User</h3>
                <form id="user-form">
                    <div class="form-group">
                        <label for="user-name">User Name</label>
                        <input type="text" id="user-name" required>
                    </div>
                    <div class="form-group">
                        <label for="user-type">Type</label>
                        <select id="user-type" required>
                            <option value="">Select Type</option>
                            <option value="member">Member</option>
                            <option value="guest">Guest</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-preference">Food Preference</label>
                        <select id="user-preference" required>
                            <option value="">Select Preference</option>
                            <option value="veg">Veg</option>
                            <option value="nonveg">Non-Veg</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-remarks">Remarks</label>
                        <textarea id="user-remarks" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </form>
            </div>
            
            <div class="history-data">
                <h3>User List</h3>
                <table id="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Food Preference</th>
                            <th>Remarks</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Notes Section -->
        <div id="notes" class="tab-content">
            <h2 class="section-title">Notes</h2>
            
            <div class="form-container">
                <h3>Add Note</h3>
                <form id="note-form">
                    <div class="form-group">
                        <label for="note-date">Date</label>
                        <input type="date" id="note-date" required>
                    </div>
                    <div class="form-group">
                        <label for="note-content">Note</label>
                        <textarea id="note-content" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </form>
            </div>
            
            <div class="notes-list">
                <h3>All Notes</h3>
                <div id="notes-content"></div>
            </div>
        </div>
        
        <!-- Data Section -->
        <div id="data" class="tab-content">
            <h2 class="section-title">Data Management</h2>
            
            <div class="form-container">
                <h3>Export Data</h3>
                <p style="text-align: center;">Export all your data as a JSON file for backup or transfer.</p>
                <button id="export-btn" class="btn btn-green" style="width: 100%;">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
            
            <div class="form-container">
                <h3>Import Data</h3>
                <p style="text-align: center;">Import data from a previously exported JSON file.</p>
                <div class="form-group">
                    <label for="import-file">Select JSON File</label>
                    <input type="file" id="import-file" accept=".json">
                </div>
                <button id="import-btn" class="btn btn-orange" style="width: 100%;">
                    <i class="fas fa-upload"></i> Import Data
                </button>
            </div>
            
            <div class="form-container" style="display: none;">
                <h3>Clear All Data</h3>
                <p style="text-align: center;">Warning: This will permanently delete all your data.</p>
                <button id="clear-btn" class="btn btn-red" style="width: 100%;">
                    <i class="fas fa-trash"></i> Clear All Data
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Menu Modal -->
    <div id="edit-menu-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Menu</h3>
                <button class="close-btn" id="close-menu-modal">&times;</button>
            </div>
            <form id="edit-menu-form">
                <input type="hidden" id="edit-menu-id">
                <div class="form-group">
                    <label for="edit-menu-date">Date</label>
                    <input type="date" id="edit-menu-date" required>
                </div>
                <div class="form-group">
                    <label for="edit-breakfast">Breakfast</label>
                    <input type="text" id="edit-breakfast" required>
                </div>
                <div class="form-group">
                    <label for="edit-lunch">Lunch</label>
                    <input type="text" id="edit-lunch" required>
                </div>
                <div class="form-group">
                    <label for="edit-dinner">Dinner</label>
                    <input type="text" id="edit-dinner" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Menu
                </button>
            </form>
        </div>
    </div>

    <!-- Edit Demand Modal -->
    <div id="edit-demand-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Demand</h3>
                <button class="close-btn" id="close-demand-modal">&times;</button>
            </div>
            <form id="edit-demand-form">
                <input type="hidden" id="edit-demand-id">
                <div class="form-group">
                    <label for="edit-demand-type">Type</label>
                    <select id="edit-demand-type" required>
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-demand-user">User</label>
                    <select id="edit-demand-user" required>
                        <option value="">Select User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-demand-menu">Menu</label>
                    <input type="text" id="edit-demand-menu" required>
                </div>
                <div class="form-group">
                    <label for="edit-demand-remarks">Remarks</label>
                    <textarea id="edit-demand-remarks" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Demand
                </button>
            </form>
        </div>
    </div>

    <script>
        // =============================================
        // FIREBASE CONFIGURATION
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyB44U0pf_i3PVNou5ounW14hC2BjLk4EQc",
            authDomain: "mess-management-app-29253.firebaseapp.com",
            projectId: "mess-management-app-29253",
            storageBucket: "mess-management-app-29253.firebasestorage.app",
            messagingSenderId: "637261673523",
            appId: "1:637261673523:web:930acaf849f55fb5abdf46"
        };

        // =============================================
        // LOGIN CREDENTIALS
        // =============================================
        const ADMIN_USERNAME = "jinurajtvpm"; 
        const ADMIN_PASSWORD = "Trinity@5";
        const LOGIN_STORAGE_KEY = "mess_admin_logged_in";

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Firebase collections
        const COLLECTIONS = {
            MENU: 'menu',
            WEEKLY_MENU: 'weekly_menu',
            DEMAND: 'demand',
            USERS: 'users',
            NOTES: 'notes'
        };

        // Global variables
        let unsubscribeFunctions = [];
        let isConnected = false;
        let isLoggedIn = false;
        let currentMenus = [];
        let currentWeeklyMenus = [];
        let currentDemands = [];
        let currentUsers = [];
        let currentNotes = [];
        let currentWeekOffset = 0; // For weekly menu navigation
        let weeklyMenuFormData = {}; // Store weekly menu form data
        let currentDemandView = 'user'; // 'user' or 'type'
        let currentDemandViewDate = ''; // Current date for demand view

        // Login persistence - Check if user was previously logged in
        function checkLoginStatus() {
            const savedLogin = localStorage.getItem(LOGIN_STORAGE_KEY);
            if (savedLogin === 'true') {
                isLoggedIn = true;
                updateUIForLogin();
            }
        }

        // Save login status to localStorage
        function saveLoginStatus(loggedIn) {
            localStorage.setItem(LOGIN_STORAGE_KEY, loggedIn.toString());
        }

        // Login functionality
        document.getElementById('open-login-btn').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'flex';
        });

        document.getElementById('close-login-modal').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('login-error').style.display = 'none';
        });

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                saveLoginStatus(true);
                updateUIForLogin();
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('login-error').style.display = 'none';
                this.reset();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            isLoggedIn = false;
            saveLoginStatus(false);
            updateUIForLogout();
        });

        function updateUIForLogin() {
            document.getElementById('open-login-btn').style.display = 'none';
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('users-tab').style.display = 'flex';
            document.getElementById('data-tab').style.display = 'flex';
            document.getElementById('weekly-menu-admin').style.display = 'block';
            document.getElementById('menu-form-container').style.display = 'block';
            document.getElementById('menu-history-container').style.display = 'block';
            document.getElementById('demand-form-container').style.display = 'block';
            document.getElementById('demand-history-container').style.display = 'block';
            
            // Update action buttons visibility
            updateActionButtons();
            
            // Force reload data after login state change
            setTimeout(() => {
                loadAllData();
            }, 100);
        }

        function updateUIForLogout() {
            document.getElementById('open-login-btn').style.display = 'flex';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('users-tab').style.display = 'none';
            document.getElementById('data-tab').style.display = 'none';
            document.getElementById('weekly-menu-admin').style.display = 'none';
            document.getElementById('menu-form-container').style.display = 'none';
            document.getElementById('menu-history-container').style.display = 'none';
            document.getElementById('demand-form-container').style.display = 'none';
            document.getElementById('demand-history-container').style.display = 'none';
            
            // If currently on protected tabs, switch to first tab
            const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
            if (activeTab === 'users' || activeTab === 'data') {
                document.querySelector('.tab-btn[data-tab="mess-menu"]').click();
            }
            
            // Update action buttons visibility
            updateActionButtons();
            
            // Force reload data after logout state change
            setTimeout(() => {
                loadAllData();
            }, 100);
        }

        function updateActionButtons() {
    const isVisible = isLoggedIn ? '' : 'none';
    
    // Update table headers
    document.getElementById('menu-history-action-header').style.display = isVisible;
    document.getElementById('demand-history-action-header').style.display = isVisible;
    
    // Update action cells
    const actionCells = document.querySelectorAll('.vertical-demand-table .action-cell');
    actionCells.forEach(cell => {
        cell.style.display = isVisible;
        
        // Ensure buttons stay inline
        const buttons = cell.querySelectorAll('button');
        buttons.forEach(button => {
            button.style.display = 'inline-block';
            button.style.marginRight = '5px';
        });
    });
}

        // Connection monitoring
        function monitorConnection() {
            db.enableNetwork()
                .then(() => {
                    return db.collection(COLLECTIONS.USERS).limit(1).get();
                })
                .then(() => {
                    updateConnectionStatus(true);
                })
                .catch((error) => {
                    console.error('Connection error:', error);
                    updateConnectionStatus(false);
                });
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                console.log('Firebase connection established');
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                console.log('Firebase connection lost');
            }
        }

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
                
                // Load weekly menu data if weekly menu tab is selected
                if (button.dataset.tab === 'weekly-menu') {
                    loadWeeklyMenuData();
                }
            });
        });

        // Today's date in YYYY-MM-DD format
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        // Tomorrow's date in YYYY-MM-DD format
        function getTomorrow() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toISOString().split('T')[0];
        }

        // Format date for display
        function formatDate(dateString) {
            const options = { month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        // Get day name from date
        function getDayName(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString(undefined, { weekday: 'long' });
        }

        // Get week start date (Monday)
        function getWeekStartDate(offset = 0) {
            const date = new Date();
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
            const monday = new Date(date.setDate(diff));
            monday.setDate(monday.getDate() + (offset * 7));
            return monday.toISOString().split('T')[0];
        }

        // Get dates for a week
        function getWeekDates(weekStartDate) {
            const dates = [];
            const startDate = new Date(weekStartDate);
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date.toISOString().split('T')[0]);
            }
            
            return dates;
        }

        // Format week title
        function formatWeekTitle(weekStartDate) {
            const startDate = new Date(weekStartDate);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            const options = { month: 'short', day: 'numeric' };
            const startStr = startDate.toLocaleDateString(undefined, options);
            const endStr = endDate.toLocaleDateString(undefined, options);
            
            return `${startStr} - ${endStr}`;
        }

        // Modal functionality
        const editMenuModal = document.getElementById('edit-menu-modal');
        const editDemandModal = document.getElementById('edit-demand-modal');
        const loginModal = document.getElementById('login-modal');
        
        document.getElementById('close-menu-modal').addEventListener('click', () => {
            editMenuModal.style.display = 'none';
        });
        
        document.getElementById('close-demand-modal').addEventListener('click', () => {
            editDemandModal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === editMenuModal) {
                editMenuModal.style.display = 'none';
            }
            if (e.target === editDemandModal) {
                editDemandModal.style.display = 'none';
            }
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
                document.getElementById('login-error').style.display = 'none';
            }
        });

        // Load all data from Firebase
        function loadAllData() {
            console.log('Loading all data, login status:', isLoggedIn);
            
            // Clear existing listeners to prevent duplicates
            unsubscribeFunctions.forEach(unsubscribe => {
                if (unsubscribe && typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            unsubscribeFunctions = [];
            
            loadMenuData();
            loadWeeklyMenuData();
            loadDemandData();
            loadUsersData();
            loadNotesData();
        }

        // MESS MENU SECTION
        document.getElementById('menu-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const menuData = {
                date: document.getElementById('menu-date').value,
                breakfast: document.getElementById('breakfast').value,
                lunch: document.getElementById('lunch').value,
                dinner: document.getElementById('dinner').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            addMenu(menuData);
            this.reset();
            document.getElementById('menu-date').value = getToday();
        });

        // Auto-fill menu based on weekly menu when date changes
        document.getElementById('menu-date').addEventListener('change', function() {
            autoFillMenuFromWeekly(this.value);
        });

        function autoFillMenuFromWeekly(date) {
            const dayName = getDayName(date);
            const dayIndex = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].indexOf(dayName);
            
            if (dayIndex !== -1 && weeklyMenuFormData.days && weeklyMenuFormData.days[dayIndex]) {
                document.getElementById('breakfast').value = weeklyMenuFormData.days[dayIndex].breakfast || '';
                document.getElementById('lunch').value = weeklyMenuFormData.days[dayIndex].lunch || '';
                document.getElementById('dinner').value = weeklyMenuFormData.days[dayIndex].dinner || '';
            }
        }

        function addMenu(menuData) {
            // Check if menu for this date already exists
            db.collection(COLLECTIONS.MENU)
                .where('date', '==', menuData.date)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        // Update existing menu
                        const doc = querySnapshot.docs[0];
                        db.collection(COLLECTIONS.MENU).doc(doc.id).update({
                            breakfast: menuData.breakfast,
                            lunch: menuData.lunch,
                            dinner: menuData.dinner,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            console.log('Menu updated successfully for date:', menuData.date);
                        });
                    } else {
                        // Add new menu
                        db.collection(COLLECTIONS.MENU).add(menuData)
                            .then(() => {
                                console.log('New menu added for date:', menuData.date);
                            });
                    }
                })
                .catch((error) => {
                    console.error('Error adding menu:', error);
                    alert('Error adding menu. Please check connection.');
                });
        }

        function loadMenuData() {
            const unsubscribe = db.collection(COLLECTIONS.MENU)
                .orderBy('date', 'desc')
                .onSnapshot((querySnapshot) => {
                    currentMenus = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        currentMenus.push({ 
                            id: doc.id, 
                            ...data,
                            // Ensure date is properly formatted
                            date: data.date || ''
                        });
                    });
                    console.log('Menu data loaded:', currentMenus.length, 'items');
                    displayTodayMenu(currentMenus);
                    displayTomorrowMenu(currentMenus);
                    displayAllMenus(currentMenus);
                    updateActionButtons();
                }, (error) => {
                    console.error('Error loading menus:', error);
                    updateConnectionStatus(false);
                });
            
            unsubscribeFunctions.push(unsubscribe);
        }

        function displayTodayMenu(menus) {
            const today = getToday();
            const todayMenu = menus.find(menu => menu.date === today);
            
            if (todayMenu) {
                document.getElementById('today-breakfast').textContent = todayMenu.breakfast || '-';
                document.getElementById('today-lunch').textContent = todayMenu.lunch || '-';
                document.getElementById('today-dinner').textContent = todayMenu.dinner || '-';
            } else {
                document.getElementById('today-breakfast').textContent = '-';
                document.getElementById('today-lunch').textContent = '-';
                document.getElementById('today-dinner').textContent = '-';
            }
        }

        function displayTomorrowMenu(menus) {
            const tomorrow = getTomorrow();
            const tomorrowMenu = menus.find(menu => menu.date === tomorrow);
            
            if (tomorrowMenu) {
                document.getElementById('tomorrow-breakfast').textContent = tomorrowMenu.breakfast || '-';
                document.getElementById('tomorrow-lunch').textContent = tomorrowMenu.lunch || '-';
                document.getElementById('tomorrow-dinner').textContent = tomorrowMenu.dinner || '-';
            } else {
                document.getElementById('tomorrow-breakfast').textContent = '-';
                document.getElementById('tomorrow-lunch').textContent = '-';
                document.getElementById('tomorrow-dinner').textContent = '-';
            }
        }

        function displayAllMenus(menus) {
            const historyBody = document.getElementById('menu-history-body');
            
            historyBody.innerHTML = '';
            
            if (menus.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No menus added yet.</td></tr>';
                return;
            }
            
            menus.forEach(menu => {
                const row = document.createElement('tr');
                const actionButtons = isLoggedIn ? 
                    `<td class="action-cell">
                        <button class="icon-btn edit-btn" onclick="openEditMenuModal('${menu.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn delete-btn" onclick="deleteMenu('${menu.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>` : 
                    `<td style="display: none;"></td>`;
                
                row.innerHTML = `
                    <td>${formatDate(menu.date)}</td>
                    <td>${menu.breakfast || '-'}</td>
                    <td>${menu.lunch || '-'}</td>
                    <td>${menu.dinner || '-'}</td>
                    ${actionButtons}
                `;
                historyBody.appendChild(row);
            });
        }

        function openEditMenuModal(menuId) {
            if (!isLoggedIn) {
                alert('Please login to edit menu');
                document.getElementById('open-login-btn').click();
                return;
            }
            
            const menu = currentMenus.find(m => m.id === menuId);
            if (menu) {
                document.getElementById('edit-menu-id').value = menu.id;
                document.getElementById('edit-menu-date').value = menu.date;
                document.getElementById('edit-breakfast').value = menu.breakfast || '';
                document.getElementById('edit-lunch').value = menu.lunch || '';
                document.getElementById('edit-dinner').value = menu.dinner || '';
                editMenuModal.style.display = 'flex';
            }
        }

        document.getElementById('edit-menu-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const menuData = {
                date: document.getElementById('edit-menu-date').value,
                breakfast: document.getElementById('edit-breakfast').value,
                lunch: document.getElementById('edit-lunch').value,
                dinner: document.getElementById('edit-dinner').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            updateMenu(document.getElementById('edit-menu-id').value, menuData);
        });

        function updateMenu(id, menuData) {
            db.collection(COLLECTIONS.MENU).doc(id).update(menuData)
                .then(() => {
                    console.log('Menu updated successfully');
                    editMenuModal.style.display = 'none';
                })
                .catch((error) => {
                    console.error('Error updating menu:', error);
                    alert('Error updating menu. Please check connection.');
                });
        }

        function deleteMenu(id) {
            if (!isLoggedIn) {
                alert('Please login to delete menu');
                document.getElementById('open-login-btn').click();
                return;
            }
            
            if (confirm('Are you sure you want to delete this menu?')) {
                db.collection(COLLECTIONS.MENU).doc(id).delete()
                    .then(() => {
                        console.log('Menu deleted successfully');
                    })
                    .catch((error) => {
                        console.error('Error deleting menu:', error);
                        alert('Error deleting menu. Please check connection.');
                    });
            }
        }

        // WEEKLY MENU SECTION
        document.getElementById('prev-week').addEventListener('click', () => {
            currentWeekOffset--;
            loadWeeklyMenuData();
        });

        document.getElementById('next-week').addEventListener('click', () => {
            currentWeekOffset++;
            loadWeeklyMenuData();
        });

        function loadWeeklyMenuData() {
            const weekStartDate = getWeekStartDate(currentWeekOffset);
            document.getElementById('week-title').textContent = formatWeekTitle(weekStartDate);
            
            // Check if weekly menu exists for this week
            db.collection(COLLECTIONS.WEEKLY_MENU)
                .where('weekStart', '==', weekStartDate)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        const weeklyMenu = { id: doc.id, ...doc.data() };
                        displayWeeklyMenu(weeklyMenu);
                        populateWeeklyMenuForm(weeklyMenu);
                    } else {
                        // Create empty weekly menu
                        const emptyWeeklyMenu = {
                            weekStart: weekStartDate,
                            days: Array(7).fill().map(() => ({ breakfast: '', lunch: '', dinner: '' }))
                        };
                        displayWeeklyMenu(emptyWeeklyMenu);
                        populateWeeklyMenuForm(emptyWeeklyMenu);
                    }
                })
                .catch((error) => {
                    console.error('Error loading weekly menu:', error);
                });
        }

        function displayWeeklyMenu(weeklyMenu) {
            const weeklyMenuBody = document.getElementById('weekly-menu-body');
            const weekDates = getWeekDates(weeklyMenu.weekStart);
            const today = getToday();
            
            weeklyMenuBody.innerHTML = '';
            
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            dayNames.forEach((dayName, index) => {
                const date = weekDates[index];
                const isToday = date === today;
                const dayData = weeklyMenu.days[index] || { breakfast: '', lunch: '', dinner: '' };
                
                const row = document.createElement('tr');
                if (isToday) {
                    row.classList.add('today-cell');
                }
                
                row.innerHTML = `
                    <td class="day-header">${dayName}<br><small>${formatDate(date)}</small></td>
                    <td>${dayData.breakfast || '-'}</td>
                    <td>${dayData.lunch || '-'}</td>
                    <td>${dayData.dinner || '-'}</td>
                `;
                
                weeklyMenuBody.appendChild(row);
            });
        }

        function populateWeeklyMenuForm(weeklyMenu) {
            const weeklyMenuDays = document.getElementById('weekly-menu-days');
            const weekDates = getWeekDates(weeklyMenu.weekStart);
            
            weeklyMenuDays.innerHTML = '';
            document.getElementById('week-start-date').value = weeklyMenu.weekStart;
            
            // Store the weekly menu data for auto-fill functionality
            weeklyMenuFormData = weeklyMenu;
            
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            dayNames.forEach((dayName, index) => {
                const date = weekDates[index];
                const dayData = weeklyMenu.days[index] || { breakfast: '', lunch: '', dinner: '' };
                
                const daySection = document.createElement('div');
                daySection.className = 'form-group';
                daySection.innerHTML = `
                    <h4>${dayName} (${formatDate(date)})</h4>
                    <div class="form-group">
                        <label for="weekly-breakfast-${index}">Breakfast</label>
                        <input type="text" id="weekly-breakfast-${index}" value="${dayData.breakfast || ''}">
                    </div>
                    <div class="form-group">
                        <label for="weekly-lunch-${index}">Lunch</label>
                        <input type="text" id="weekly-lunch-${index}" value="${dayData.lunch || ''}">
                    </div>
                    <div class="form-group">
                        <label for="weekly-dinner-${index}">Dinner</label>
                        <input type="text" id="weekly-dinner-${index}" value="${dayData.dinner || ''}">
                    </div>
                    <hr>
                `;
                
                weeklyMenuDays.appendChild(daySection);
            });
        }

        document.getElementById('weekly-menu-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!isLoggedIn) {
                alert('Please login to save weekly menu');
                document.getElementById('open-login-btn').click();
                return;
            }
            
            const weekStart = document.getElementById('week-start-date').value;
            const days = [];
            
            for (let i = 0; i < 7; i++) {
                days.push({
                    breakfast: document.getElementById(`weekly-breakfast-${i}`).value,
                    lunch: document.getElementById(`weekly-lunch-${i}`).value,
                    dinner: document.getElementById(`weekly-dinner-${i}`).value
                });
            }
            
            const weeklyMenuData = {
                weekStart: weekStart,
                days: days,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            saveWeeklyMenu(weeklyMenuData);
        });

        function saveWeeklyMenu(weeklyMenuData) {
            // Check if weekly menu for this week already exists
            db.collection(COLLECTIONS.WEEKLY_MENU)
                .where('weekStart', '==', weeklyMenuData.weekStart)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        // Update existing weekly menu
                        const doc = querySnapshot.docs[0];
                        db.collection(COLLECTIONS.WEEKLY_MENU).doc(doc.id).update({
                            days: weeklyMenuData.days,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            console.log('Weekly menu updated successfully for week:', weeklyMenuData.weekStart);
                            alert('Weekly menu updated successfully!');
                            // Update the stored form data
                            weeklyMenuFormData = weeklyMenuData;
                        });
                    } else {
                        // Add new weekly menu
                        db.collection(COLLECTIONS.WEEKLY_MENU).add(weeklyMenuData)
                            .then(() => {
                                console.log('New weekly menu added for week:', weeklyMenuData.weekStart);
                                alert('Weekly menu saved successfully!');
                                // Update the stored form data
                                weeklyMenuFormData = weeklyMenuData;
                            });
                    }
                })
                .catch((error) => {
                    console.error('Error saving weekly menu:', error);
                    alert('Error saving weekly menu. Please check connection.');
                });
        }

        // DEMAND SECTION - FIXED FOR MOBILE BROWSERS
        document.getElementById('demand-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get selected users from the multi-select
            const selectedUsers = Array.from(document.getElementById('demand-users').selectedOptions).map(option => option.value);
            
            // Filter out empty values
            const validUsers = selectedUsers.filter(user => user && user.trim() !== '');
            
            if (validUsers.length === 0) {
                alert('Please select at least one user');
                return;
            }
            
            const type = document.getElementById('demand-type').value;
            const date = document.getElementById('demand-date').value;
            const menu = document.getElementById('demand-menu').value;
            const remarks = document.getElementById('demand-remarks').value;
            
            // Validate all required fields
            if (!type || !date || !menu) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Add demand for each selected user
            let successCount = 0;
            let errorCount = 0;
            
            validUsers.forEach(user => {
                const demandData = {
                    date: date,
                    user: user,
                    type: type,
                    menu: menu,
                    remarks: remarks,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                addDemand(demandData)
                    .then(() => {
                        successCount++;
                        if (successCount + errorCount === validUsers.length) {
                            // All demands processed
                            if (errorCount === 0) {
                                // Reset form
                                this.reset();
                                document.getElementById('demand-date').value = getToday();
                                alert('Demand added successfully!');
                            } else {
                                alert(`Added ${successCount} demands, but ${errorCount} failed.`);
                            }
                        }
                    })
                    .catch((error) => {
                        errorCount++;
                        console.error('Error adding demand:', error);
                        if (successCount + errorCount === validUsers.length) {
                            if (errorCount === validUsers.length) {
                                alert('Error adding demand. Please check connection.');
                            } else {
                                alert(`Added ${successCount} demands, but ${errorCount} failed.`);
                            }
                        }
                    });
            });
        });

        // Auto-fill menu based on selected type and date - FROM WEEKLY MENU ONLY
        document.getElementById('demand-type').addEventListener('change', function() {
            autoFillMenuFieldFromWeekly();
        });

        document.getElementById('demand-date').addEventListener('change', function() {
            autoFillMenuFieldFromWeekly();
        });

        function autoFillMenuFieldFromWeekly() {
            const type = document.getElementById('demand-type').value;
            const date = document.getElementById('demand-date').value;
            const menuField = document.getElementById('demand-menu');
            
            // Only auto-fill for breakfast, lunch, dinner types
            if (type && type !== 'other' && date) {
                // Get from weekly menu only
                const dayName = getDayName(date);
                const dayIndex = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].indexOf(dayName);
                
                if (dayIndex !== -1 && weeklyMenuFormData.days && weeklyMenuFormData.days[dayIndex]) {
                    switch(type) {
                        case 'breakfast':
                            menuField.value = weeklyMenuFormData.days[dayIndex].breakfast || '';
                            break;
                        case 'lunch':
                            menuField.value = weeklyMenuFormData.days[dayIndex].lunch || '';
                            break;
                        case 'dinner':
                            menuField.value = weeklyMenuFormData.days[dayIndex].dinner || '';
                            break;
                    }
                } else {
                    menuField.value = '';
                }
            } else if (type === 'other') {
                menuField.value = '';
            }
        }

        function addDemand(demandData) {
            return db.collection(COLLECTIONS.DEMAND).add(demandData);
        }

        function loadDemandData() {
            const unsubscribe = db.collection(COLLECTIONS.DEMAND)
                .orderBy('date', 'desc')
                .onSnapshot((querySnapshot) => {
                    currentDemands = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        currentDemands.push({ 
                            id: doc.id, 
                            ...data,
                            // Ensure all fields have proper values
                            date: data.date || '',
                            user: data.user || '',
                            type: data.type || '',
                            menu: data.menu || '',
                            remarks: data.remarks || ''
                        });
                    });
                    console.log('Demand data loaded:', currentDemands.length, 'items');
                    displayTodayDemand(currentDemands);
                    displayDemandHistory(currentDemands);
                    populateUserFilter();
                }, (error) => {
                    console.error('Error loading demands:', error);
                    updateConnectionStatus(false);
                });
            
            unsubscribeFunctions.push(unsubscribe);
        }

        // Date selector for demand view
        document.getElementById('demand-view-date').addEventListener('change', function() {
            currentDemandViewDate = this.value;
            updateDemandViewTitle();
            displayTodayDemand(currentDemands);
        });

        function updateDemandViewTitle() {
            const titleElement = document.getElementById('demand-date-title');
            if (currentDemandViewDate && currentDemandViewDate !== getToday()) {
                titleElement.textContent = `Demand for ${formatDate(currentDemandViewDate)}`;
            } else {
                titleElement.textContent = "Today's Demand";
            }
        }

        // View toggle functionality
        document.getElementById('user-view-btn').addEventListener('click', function() {
            if (currentDemandView !== 'user') {
                currentDemandView = 'user';
                this.classList.add('active');
                document.getElementById('type-view-btn').classList.remove('active');
                document.getElementById('user-wise-view').style.display = 'block';
                document.getElementById('type-wise-view').style.display = 'none';
                displayTodayDemand(currentDemands);
            }
        });

        document.getElementById('type-view-btn').addEventListener('click', function() {
            if (currentDemandView !== 'type') {
                currentDemandView = 'type';
                this.classList.add('active');
                document.getElementById('user-view-btn').classList.remove('active');
                document.getElementById('user-wise-view').style.display = 'none';
                document.getElementById('type-wise-view').style.display = 'block';
                displayTodayDemandByType(currentDemands);
            }
        });

        // Vertical layout for today's demand (user-wise)
        function displayTodayDemand(demands) {
            const viewDate = currentDemandViewDate || getToday();
            const todayDemands = demands.filter(demand => demand.date === viewDate);
            const todayDemandContent = document.getElementById('today-demand-content');
            
            // Sort demands by creation time to find the latest
            const sortedDemands = [...todayDemands].sort((a, b) => {
                const timeA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                const timeB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
                return timeB - timeA; // Latest first
            });
            
            const latestDemandId = sortedDemands.length > 0 ? sortedDemands[0].id : null;
            
            // Group demands by user
            const userDemands = {};
            todayDemands.forEach(demand => {
                if (!userDemands[demand.user]) {
                    userDemands[demand.user] = [];
                }
                userDemands[demand.user].push(demand);
            });
            
            todayDemandContent.innerHTML = '';
            
            if (Object.keys(userDemands).length === 0) {
                todayDemandContent.innerHTML = `<p style="text-align:center; padding:10px;">No demands for ${formatDate(viewDate)}.</p>`;
                return;
            }
            
            for (const user in userDemands) {
                const userTile = document.createElement('div');
                userTile.className = 'user-tile';
                
                let demandHTML = `
                    <div class="user-tile-header">
                        <h4>${user}</h4>
                        <span>${formatDate(viewDate)}</span>
                    </div>
                    <table class="vertical-demand-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th class="menu-column">Menu</th>
                                <th class="action-column">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Group demands by type
                const demandItems = {
                    breakfast: [],
                    lunch: [],
                    dinner: [],
                    other: []
                };
                
                // Group demands by type
                userDemands[user].forEach(demand => {
                    if (demandItems[demand.type]) {
                        demandItems[demand.type].push(demand);
                    }
                });
                
                // Create rows with merged type cells
                for (const type in demandItems) {
                    if (demandItems[type].length > 0) {
                        const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
                        const rowCount = demandItems[type].length;
                        
                        // First row with type label and rowspan
                        const isLatestRow = demandItems[type][0].id === latestDemandId;
                        const rowClass = isLatestRow ? 'highlight-row' : '';
                        
                        demandHTML += `
                            <tr class="${rowClass}">
                                <td rowspan="${rowCount}" class="type-cell">${typeLabel}</td>
                                <td class="menu-cell">${demandItems[type][0].menu}</td>
                                <td class="action-cell">
                                    <div class="action-cell">
                                        <button class="icon-btn edit-btn" onclick="openEditDemandModal('${demandItems[type][0].id}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="icon-btn delete-btn" onclick="deleteDemand('${demandItems[type][0].id}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        
                        // Remaining rows for the same type (without type cell)
                        for (let i = 1; i < demandItems[type].length; i++) {
                            const isLatestSubRow = demandItems[type][i].id === latestDemandId;
                            const subRowClass = isLatestSubRow ? 'highlight-row' : '';
                            
                            demandHTML += `
                                <tr class="${subRowClass}">
                                    <td class="menu-cell">${demandItems[type][i].menu}</td>
                                    <td class="action-cell">
                                        <div class="action-cell">
                                            <button class="icon-btn edit-btn" onclick="openEditDemandModal('${demandItems[type][i].id}')" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="icon-btn delete-btn" onclick="deleteDemand('${demandItems[type][i].id}')" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }
                    }
                }
                
                // Add remarks row if any
                const remarks = userDemands[user].filter(d => d.remarks).map(d => d.remarks);
                if (remarks.length > 0) {
                    demandHTML += `
                        <tr>
                            <td>Remarks</td>
                            <td class="menu-cell" colspan="2">${remarks.join(', ')}</td>
                        </tr>
                    `;
                }
                
                demandHTML += `
                        </tbody>
                    </table>
                `;
                
                userTile.innerHTML = demandHTML;
                todayDemandContent.appendChild(userTile);
            }
            
            // Update action buttons visibility
            updateActionButtons();
        }

        // Type-wise layout for today's demand
        function displayTodayDemandByType(demands) {
            const viewDate = currentDemandViewDate || getToday();
            const todayDemands = demands.filter(demand => demand.date === viewDate);
            const todayDemandTypeContent = document.getElementById('today-demand-type-content');
            
            // Sort demands by creation time to find the latest
            const sortedDemands = [...todayDemands].sort((a, b) => {
                const timeA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                const timeB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
                return timeB - timeA; // Latest first
            });
            
            const latestDemandId = sortedDemands.length > 0 ? sortedDemands[0].id : null;
            
            // Group demands by type
            const typeDemands = {
                breakfast: [],
                lunch: [],
                dinner: [],
                other: []
            };
            
            todayDemands.forEach(demand => {
                if (typeDemands[demand.type]) {
                    typeDemands[demand.type].push(demand);
                }
            });
            
            todayDemandTypeContent.innerHTML = '';
            
            if (Object.keys(typeDemands).length === 0) {
                todayDemandTypeContent.innerHTML = `<p style="text-align:center; padding:10px;">No demands for ${formatDate(viewDate)}.</p>`;
                return;
            }
            
            for (const type in typeDemands) {
                if (typeDemands[type].length > 0) {
                    const typeTile = document.createElement('div');
                    const typeClass = `type-tile type-tile-${type}`;
                    typeTile.className = typeClass;
                    
                    const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
                    
                    let demandHTML = `
                        <div class="type-tile-header">
                            <h4>${typeLabel}</h4>
                            <span>${formatDate(viewDate)}</span>
                        </div>
                        <table class="vertical-demand-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th class="menu-column">Menu</th>
                                    <th class="action-column">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // Create rows for each demand
                    typeDemands[type].forEach(demand => {
                        const isLatestRow = demand.id === latestDemandId;
                        const rowClass = isLatestRow ? 'highlight-row' : '';
                        
                        demandHTML += `
                            <tr class="${rowClass}">
                                <td class="type-cell">${demand.user}</td>
                                <td class="menu-cell">${demand.menu}</td>
                                <td class="action-cell">
                                    <div class="action-cell">
                                        <button class="icon-btn edit-btn" onclick="openEditDemandModal('${demand.id}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="icon-btn delete-btn" onclick="deleteDemand('${demand.id}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    // Add remarks row if any
                    const remarks = typeDemands[type].filter(d => d.remarks).map(d => d.remarks);
                    if (remarks.length > 0) {
                        demandHTML += `
                            <tr>
                                <td>Remarks</td>
                                <td class="menu-cell" colspan="2">${remarks.join(', ')}</td>
                            </tr>
                        `;
                    }
                    
                    demandHTML += `
                            </tbody>
                        </table>
                    `;
                    
                    typeTile.innerHTML = demandHTML;
                    todayDemandTypeContent.appendChild(typeTile);
                }
            }
            
            // Update action buttons visibility
            updateActionButtons();
        }

        function populateUserFilter() {
            const userFilter = document.getElementById('user-filter');
            const uniqueUsers = [...new Set(currentDemands.map(demand => demand.user))].sort();
            
            // Clear existing options except the first one
            while (userFilter.options.length > 1) {
                userFilter.remove(1);
            }
            
            // Add user options
            uniqueUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userFilter.appendChild(option);
            });
        }

        function displayDemandHistory(demands) {
            const historyBody = document.getElementById('demand-history-body');
            const userFilter = document.getElementById('user-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            
            // Filter demands based on selected filters
            let filteredDemands = demands.filter(demand => {
                const matchesUser = !userFilter || demand.user === userFilter;
                const matchesDate = !dateFilter || demand.date === dateFilter;
                const matchesType = !typeFilter || demand.type === typeFilter;
                return matchesUser && matchesDate && matchesType;
            });
            
            historyBody.innerHTML = '';
            
            if (filteredDemands.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No demand history found.</td></tr>';
                return;
            }
            
            filteredDemands.forEach(demand => {
                const actionButtons = isLoggedIn ? 
                    `<td class="action-cell">
                        <button class="icon-btn edit-btn" onclick="openEditDemandModal('${demand.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn delete-btn" onclick="deleteDemand('${demand.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>` : 
                    `<td style="display: none;"></td>`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(demand.date)}</td>
                    <td>${demand.user}</td>
                    <td>${demand.type}</td>
                    <td>${demand.menu}</td>
                    <td>${demand.remarks || '-'}</td>
                    ${actionButtons}
                `;
                historyBody.appendChild(row);
            });
        }

        // Add event listeners for filter controls
        document.getElementById('user-filter').addEventListener('change', () => {
            displayDemandHistory(currentDemands);
        });
        
        document.getElementById('date-filter').addEventListener('change', () => {
            displayDemandHistory(currentDemands);
        });
        
        document.getElementById('type-filter').addEventListener('change', () => {
            displayDemandHistory(currentDemands);
        });

        function openEditDemandModal(id) {
            if (!isLoggedIn) {
                alert('Please login to edit demand');
                document.getElementById('open-login-btn').click();
                return;
            }
            
            db.collection(COLLECTIONS.DEMAND).doc(id).get()
                .then((doc) => {
                    if (doc.exists) {
                        const demand = { id: doc.id, ...doc.data() };
                        document.getElementById('edit-demand-id').value = demand.id;
                        document.getElementById('edit-demand-type').value = demand.type;
                        document.getElementById('edit-demand-menu').value = demand.menu;
                        document.getElementById('edit-demand-remarks').value = demand.remarks || '';
                        
                        // Populate user dropdown
                        const userSelect = document.getElementById('edit-demand-user');
                        userSelect.innerHTML = '<option value="">Select User</option>';
                        
                        db.collection(COLLECTIONS.USERS)
                            .orderBy('name')
                            .get()
                            .then((querySnapshot) => {
                                querySnapshot.forEach((doc) => {
                                    const user = doc.data();
                                    const option = document.createElement('option');
                                    option.value = user.name;
                                    option.textContent = user.name;
                                    if (user.name === demand.user) {
                                        option.selected = true;
                                    }
                                    userSelect.appendChild(option);
                                });
                            });
                        
                        editDemandModal.style.display = 'flex';
                    }
                })
                .catch((error) => {
                    console.error('Error loading demand:', error);
                });
        }

        document.getElementById('edit-demand-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const demandData = {
                user: document.getElementById('edit-demand-user').value,
                type: document.getElementById('edit-demand-type').value,
                menu: document.getElementById('edit-demand-menu').value,
                remarks: document.getElementById('edit-demand-remarks').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            updateDemand(document.getElementById('edit-demand-id').value, demandData);
        });

        function updateDemand(id, demandData) {
            db.collection(COLLECTIONS.DEMAND).doc(id).update(demandData)
                .then(() => {
                    console.log('Demand updated successfully');
                    editDemandModal.style.display = 'none';
                })
                .catch((error) => {
                    console.error('Error updating demand:', error);
                    alert('Error updating demand. Please check connection.');
                });
        }

        function deleteDemand(id) {
            if (!isLoggedIn) {
                alert('Please login to delete demand');
                document.getElementById('open-login-btn').click();
                return;
            }
            
            if (confirm('Are you sure you want to delete this demand?')) {
                db.collection(COLLECTIONS.DEMAND).doc(id).delete()
                    .then(() => {
                        console.log('Demand deleted successfully');
                    })
                    .catch((error) => {
                        console.error('Error deleting demand:', error);
                        alert('Error deleting demand. Please check connection.');
                    });
            }
        }

        // USERS SECTION
        document.getElementById('user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userData = {
                name: document.getElementById('user-name').value,
                type: document.getElementById('user-type').value,
                preference: document.getElementById('user-preference').value,
                remarks: document.getElementById('user-remarks').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            addUser(userData);
            this.reset();
        });

        function addUser(userData) {
            // Check if user with same name already exists
            db.collection(COLLECTIONS.USERS)
                .where('name', '==', userData.name)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        // Add new user
                        db.collection(COLLECTIONS.USERS).add(userData);
                    } else {
                        alert('User with this name already exists!');
                    }
                })
                .catch((error) => {
                    console.error('Error adding user:', error);
                    alert('Error adding user. Please check connection.');
                });
        }

        function loadUsersData() {
            const unsubscribe = db.collection(COLLECTIONS.USERS)
                .orderBy('name')
                .onSnapshot((querySnapshot) => {
                    currentUsers = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        currentUsers.push({ 
                            id: doc.id, 
                            ...data,
                            name: data.name || '',
                            type: data.type || '',
                            preference: data.preference || '',
                            remarks: data.remarks || ''
                        });
                    });
                    console.log('Users data loaded:', currentUsers.length, 'items');
                    displayUsers(currentUsers);
                    populateUserDropdown();
                }, (error) => {
                    console.error('Error loading users:', error);
                    updateConnectionStatus(false);
                });
            
            unsubscribeFunctions.push(unsubscribe);
        }

        function displayUsers(users) {
            const userTableBody = document.getElementById('user-table-body');
            userTableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.type}</td>
                    <td>${user.preference}</td>
                    <td>${user.remarks || ''}</td>
                    <td class="action-cell">
                        <button class="icon-btn delete-btn" onclick="deleteUser('${user.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                userTableBody.appendChild(row);
            });
        }

        function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                db.collection(COLLECTIONS.USERS).doc(id).delete()
                    .then(() => {
                        console.log('User deleted successfully');
                    })
                    .catch((error) => {
                        console.error('Error deleting user:', error);
                        alert('Error deleting user. Please check connection.');
                    });
            }
        }

        function populateUserDropdown() {
            db.collection(COLLECTIONS.USERS)
                .orderBy('name')
                .get()
                .then((querySnapshot) => {
                    const userDropdown = document.getElementById('demand-users');
                    
                    // Clear existing options except the first one
                    while (userDropdown.options.length > 1) {
                        userDropdown.remove(1);
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const user = doc.data();
                        
                        // Add to regular dropdown
                        const option = document.createElement('option');
                        option.value = user.name;
                        option.textContent = user.name;
                        userDropdown.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error('Error loading users for dropdown:', error);
                });
        }

        // NOTES SECTION
        document.getElementById('note-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const noteData = {
                date: document.getElementById('note-date').value,
                content: document.getElementById('note-content').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            addNote(noteData);
            this.reset();
            document.getElementById('note-date').value = getToday();
        });

        function addNote(noteData) {
            db.collection(COLLECTIONS.NOTES).add(noteData)
                .catch((error) => {
                    console.error('Error adding note:', error);
                    alert('Error adding note. Please check connection.');
                });
        }

        function loadNotesData() {
            const unsubscribe = db.collection(COLLECTIONS.NOTES)
                .orderBy('date', 'desc')
                .onSnapshot((querySnapshot) => {
                    currentNotes = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        currentNotes.push({ 
                            id: doc.id, 
                            ...data,
                            date: data.date || '',
                            content: data.content || ''
                        });
                    });
                    console.log('Notes data loaded:', currentNotes.length, 'items');
                    displayNotes(currentNotes);
                }, (error) => {
                    console.error('Error loading notes:', error);
                    updateConnectionStatus(false);
                });
            
            unsubscribeFunctions.push(unsubscribe);
        }

        function displayNotes(notes) {
            const notesContent = document.getElementById('notes-content');
            
            notesContent.innerHTML = '';
            
            if (notes.length === 0) {
                notesContent.innerHTML = '<p>No notes yet.</p>';
                return;
            }
            
            notes.forEach(note => {
                const noteItem = document.createElement('div');
                const deleteButton = isLoggedIn ? 
                    `<button class="icon-btn delete-btn" onclick="deleteNote('${note.id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>` : '';
                
                noteItem.className = 'note-item';
                noteItem.innerHTML = `
                    <div class="note-content">
                        <div class="note-date">${formatDate(note.date)}</div>
                        <div class="note-text">${note.content}</div>
                    </div>
                    ${deleteButton}
                `;
                notesContent.appendChild(noteItem);
            });
        }

        function deleteNote(id) {
            if (!isLoggedIn) {
                alert('Please login to delete notes');
                document.getElementById('open-login-btn').click();
                return;
            }
            
            if (confirm('Are you sure you want to delete this note?')) {
                db.collection(COLLECTIONS.NOTES).doc(id).delete()
                    .then(() => {
                        console.log('Note deleted successfully');
                    })
                    .catch((error) => {
                        console.error('Error deleting note:', error);
                        alert('Error deleting note. Please check connection.');
                    });
            }
        }

        // DATA EXPORT/IMPORT SECTION
        document.getElementById('export-btn').addEventListener('click', exportData);
        document.getElementById('import-btn').addEventListener('click', importData);
        document.getElementById('clear-btn').addEventListener('click', clearAllData);

        async function exportData() {
            if (!isLoggedIn) {
                alert('Please login to export data');
                document.getElementById('open-login-btn').click();
                return;
            }
            
            if (!isConnected) {
                alert('Cannot export data while disconnected from Firebase.');
                return;
            }
            
            try {
                // Get all data from all collections
                const [menuSnapshot, weeklyMenuSnapshot, demandSnapshot, usersSnapshot, notesSnapshot] = await Promise.all([
                    db.collection(COLLECTIONS.MENU).get(),
                    db.collection(COLLECTIONS.WEEKLY_MENU).get(),
                    db.collection(COLLECTIONS.DEMAND).get(),
                    db.collection(COLLECTIONS.USERS).get(),
                    db.collection(COLLECTIONS.NOTES).get()
                ]);
                
                const exportData = {
                    menu: menuSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    weekly_menu: weeklyMenuSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    demand: demandSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    users: usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    notes: notesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    exportDate: new Date().toISOString()
                };
                
                // Create and download JSON file
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `mess-management-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        async function importData() {
            if (!isLoggedIn) {
                alert('Please login to import data');
                document.getElementById('open-login-btn').click();
                return;
            }
            
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            
            if (!isConnected) {
                alert('Cannot import data while disconnected from Firebase.');
                return;
            }
            
            if (!confirm('This will replace all your current data. Are you sure?')) {
                return;
            }
            
            try {
                const fileText = await readFileAsText(file);
                const importData = JSON.parse(fileText);
                
                // Clear existing data
                await clearAllData(true);
                
                // Import new data
                const batch = db.batch();
                
                if (importData.menu) {
                    importData.menu.forEach(item => {
                        const docRef = db.collection(COLLECTIONS.MENU).doc();
                        const { id, ...data } = item;
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        batch.set(docRef, data);
                    });
                }
                
                if (importData.weekly_menu) {
                    importData.weekly_menu.forEach(item => {
                        const docRef = db.collection(COLLECTIONS.WEEKLY_MENU).doc();
                        const { id, ...data } = item;
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        batch.set(docRef, data);
                    });
                }
                
                if (importData.demand) {
                    importData.demand.forEach(item => {
                        const docRef = db.collection(COLLECTIONS.DEMAND).doc();
                        const { id, ...data } = item;
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        batch.set(docRef, data);
                    });
                }
                
                if (importData.users) {
                    importData.users.forEach(item => {
                        const docRef = db.collection(COLLECTIONS.USERS).doc();
                        const { id, ...data } = item;
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        batch.set(docRef, data);
                    });
                }
                
                if (importData.notes) {
                    importData.notes.forEach(item => {
                        const docRef = db.collection(COLLECTIONS.NOTES).doc();
                        const { id, ...data } = item;
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        batch.set(docRef, data);
                    });
                }
                
                await batch.commit();
                fileInput.value = '';
                alert('Data imported successfully!');
            } catch (error) {
                console.error('Error importing data:', error);
                alert('Error importing data: ' + error.message);
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        async function clearAllData(silent = false) {
            if (!silent && !confirm('This will permanently delete ALL your data. Are you sure?')) {
                return;
            }
            
            if (!isConnected) {
                if (!silent) alert('Cannot clear data while disconnected from Firebase.');
                return;
            }
            
            try {
                // Delete all documents from all collections
                const collections = [COLLECTIONS.MENU, COLLECTIONS.WEEKLY_MENU, COLLECTIONS.DEMAND, COLLECTIONS.USERS, COLLECTIONS.NOTES];
                
                for (const collectionName of collections) {
                    const snapshot = await db.collection(collectionName).get();
                    
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                }
                
                if (!silent) {
                    alert('All data cleared successfully!');
                }
            } catch (error) {
                console.error('Error clearing data:', error);
                if (!silent) {
                    alert('Error clearing data: ' + error.message);
                }
            }
        }

        // Initialize the app
        window.onload = function() {
            console.log('App initializing...');
            
            // Set today's date as default in date fields
            const today = getToday();
            document.getElementById('menu-date').value = today;
            document.getElementById('demand-date').value = today;
            document.getElementById('note-date').value = today;
            document.getElementById('demand-view-date').value = today;
            currentDemandViewDate = today;
            
            // Check if user was previously logged in
            checkLoginStatus();
            
            // Start monitoring connection
            monitorConnection();
            
            // Load all data
            loadAllData();
            
            // Check connection status every 10 seconds
            setInterval(monitorConnection, 10000);
            
            // Initialize action buttons
            updateActionButtons();
            
            console.log('App initialization complete');
        };
    </script>
</body>
</html>
